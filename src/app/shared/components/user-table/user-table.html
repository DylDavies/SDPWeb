<div class="user-management-container">

  <div class="table-toolbar">
    <mat-form-field appearance="outline" class="filter-field compact-form-field">
      <mat-label>Filter Users</mat-label>
      <input matInput [formControl]="textFilterControl" placeholder="Search by name, email, status...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <button mat-stroked-button [matMenuTriggerFor]="roleMenu" class="role-filter-button">
      <mat-icon>label</mat-icon>
      <span>
        @if (roleFilterControl.value?.length) {
          {{ roleFilterControl.value!.length }} Role(s) Selected
        } @else {
          Filter by Role
        }
      </span>
    </button>
    <mat-menu #roleMenu="matMenu" class="role-filter-menu">
      <div class="role-chip-container">
        <mat-chip-listbox [formControl]="roleFilterControl" multiple>
          @for (role of allRoles; track role._id) {
            <mat-chip-option [value]="role._id" class="role-chip" [style.border-color]="role.color" [style.color]="role.color">
              {{ role.name }}
            </mat-chip-option>
          }
        </mat-chip-listbox>
      </div>
    </mat-menu>
  </div>

  @if (!isLoading) {
    @if (dataSource.data.length > 0) {
      <div class="table-responsive-wrapper">
        <table mat-table [dataSource]="dataSource" matSort matSortActive="displayName" matSortDirection="asc" class="user-table">

          <ng-container matColumnDef="avatar">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let user"><img [src]="user.picture || '/assets/no_profile_pic.png'" class="avatar" [alt]="user.displayName" referrerpolicy="no-referrer"></td>
          </ng-container>

          <ng-container matColumnDef="displayName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
            <td mat-cell *matCellDef="let user">
              <div class="user-info">
                <div class="name-status-line">
                  <span class="display-name">{{ user.displayName }}</span>
                  @if (user.pending) { <span class="status-pill pending">Pending</span> }
                  @if (user.disabled) { <span class="status-pill disabled">Disabled</span> }
                </div>
                <span class="email">{{ user.email }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="userType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> User Type </th>
            <td mat-cell *matCellDef="let user">
              @if(isAdminView) {
                <button class="user-type-button" [matMenuTriggerFor]="userTypeMenu" [disabled]="!canManageRoles" (click)="$event.stopPropagation()">
                  <span class="user-type">{{ user.type | userTypePipe }}</span>
                  <mat-icon>arrow_drop_down</mat-icon>
                </button>
                <mat-menu #userTypeMenu="matMenu">
                  @for (type of types; track type) {
                    <button mat-menu-item (click)="updateUserType(user, type, $event)">
                      <span>{{ type | userTypePipe}}</span>
                    </button>
                  }
                </mat-menu>
              } @else {
                <span class="user-type-static user-type">{{ user.type | userTypePipe }}</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="roles">
            <th mat-header-cell *matHeaderCellDef> Roles </th>
            <td mat-cell *matCellDef="let user">
              <app-role-chip-row [roles]="user.roles"></app-role-chip-row>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let user">
              <div role="group" 
                   tabindex="0" 
                   (click)="$event.stopPropagation()" 
                   (keydown.enter)="$event.stopPropagation()">
                @if (user.pending && canManageRoles && isAdminView) {
                  <button mat-icon-button color="accent" matTooltip="Approve User" (click)="approveUser(user, $event)">
                    <mat-icon>check_circle_outline</mat-icon>
                  </button>
                }
                @if (!user.disabled && canManageRoles && isAdminView) {
                  <button mat-icon-button color="warn" matTooltip="Disable User" (click)="disableUser(user, $event)">
                    <mat-icon>block</mat-icon>
                  </button>
                }
                @if (user.disabled && canManageRoles && isAdminView) {
                  <button mat-icon-button color="warn" matTooltip="Enable User" (click)="enableUser(user, $event)">
                    <mat-icon>how_to_reg</mat-icon>
                  </button>
                }
                @if (canManageRoles) {
                  <button mat-icon-button color="primary" matTooltip="Manage All Roles" (click)="manageRoles(user, $event)">
                    <mat-icon>manage_accounts</mat-icon>
                  </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row class="user-table-row" *matRowDef="let row; columns: displayedColumns;"
              [class.disabled]="row.disabled"
              [class.pending]="row.pending"
              (click)="viewProfile(row)">
          </tr>
        </table>
      </div>
      <mat-paginator [pageSizeOptions]="[10, 25, 100]" showFirstLastButtons aria-label="Select page of users"></mat-paginator>
    } @else {
      <div class="empty-state">
        <mat-icon>search_off</mat-icon>
        <h2>No Users Found</h2>
        <p>Your search and filter criteria did not match any users.</p>
      </div>
    }
  } @else {
    <div class="loading-state">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    </div>
  }
</div>