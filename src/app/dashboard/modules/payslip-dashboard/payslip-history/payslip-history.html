<mat-card>
  <mat-card-header>
    <mat-card-title>Payslip History</mat-card-title>
    <mat-card-subtitle>View your past and current payslips</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <!-- Current Rate Display -->
    <div *ngIf="currentUser$ | async as user" class="current-rate-section">
      <div class="rate-info">
        <mat-icon color="primary">payment</mat-icon>
        <span class="rate-label">Your Current Rate:</span>
        <span class="rate-value">{{ getCurrentUserRate(user) | currency:'R':'symbol':'1.2-2' }}/hr</span>
      </div>
    </div>

    <div *ngIf="pageData$ | async as data; else loading" class="table-container">

      <!-- Generate Current Payslip Section -->
      <div *ngIf="!data.hasCurrentMonthPayslip" class="generate-payslip-section">
        <div class="generate-info">
          <mat-icon color="primary">info</mat-icon>
          <span>You don't have a payslip for {{ data.currentMonth }} yet.</span>
          <button mat-raised-button color="primary" (click)="generateCurrentPayslip()" class="generate-btn">
            <mat-icon>add</mat-icon>
            Generate {{ data.currentMonth }} Payslip
          </button>
        </div>
      </div>

      <div *ngIf="data.payslips.length === 0" class="no-records">
        <p>You do not have any payslips yet.</p>
      </div>

      <table *ngIf="data.payslips.length > 0" mat-table [dataSource]="data.payslips" class="mat-elevation-z8">

        <ng-container matColumnDef="payPeriod">
          <th mat-header-cell *matHeaderCellDef> Pay Period </th>
          <td mat-cell *matCellDef="let slip"> {{ slip.payPeriod | payPeriod }} </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let slip">
            <span class="status-chip" [ngClass]="slip.status">{{ slip.status | payslipStatus }}</span>
            <mat-icon *ngIf="hasUnresolvedQueries(slip)"
                     class="query-indicator"
                     matTooltip="Has unresolved queries"
                     color="warn">help_outline</mat-icon>
          </td>
        </ng-container>


        <ng-container matColumnDef="totalIncome">
          <th mat-header-cell *matHeaderCellDef> Total Income </th>
          <td mat-cell *matCellDef="let slip"> {{ getTotalIncome(slip) | currency:'R' }} </td>
        </ng-container>

        <ng-container matColumnDef="totalDeductions">
          <th mat-header-cell *matHeaderCellDef> Total Deductions </th>
          <td mat-cell *matCellDef="let slip"> {{ slip.totalDeductions | currency:'R' }} </td>
        </ng-container>

        <ng-container matColumnDef="netPay">
          <th mat-header-cell *matHeaderCellDef> Net Pay </th>
          <td mat-cell *matCellDef="let slip"> {{ getCalculatedNetPay(slip) | currency:'R' }} </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let slip">
            <button mat-icon-button [routerLink]="['/dashboard/payslip', slip._id]" matTooltip="View Details">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <ng-template #loading>
      <div class="loading-spinner">
        <mat-spinner></mat-spinner>
      </div>
    </ng-template>
  </mat-card-content>
</mat-card>