<div class="user-management-container">
    @if (users$ | async; as users) {
      @if (users.length > 0) {
        <table mat-table [dataSource]="users" class="mat-elevation-z2 user-table">
          <!-- Avatar Column -->
          <ng-container matColumnDef="avatar">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let user"><img [src]="user.picture || '/assets/no_profile_pic.png'" class="avatar" [alt]="user.displayName"></td>
          </ng-container>

          <!-- Display Name Column -->
          <ng-container matColumnDef="displayName">
            <th mat-header-cell *matHeaderCellDef> Name </th>
            <td mat-cell *matCellDef="let user">
              <div class="user-info">
                <div class="name-status-line">
                  <span class="display-name">{{ user.displayName }}</span>
                  @if (user.pending) {
                    <span class="status-pill pending">Pending</span>
                  }
                  @if (user.disabled) {
                    <span class="status-pill disabled">Disabled</span>
                  }
                </div>
                <span class="email">{{ user.email }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="userType">
            <th mat-header-cell *matHeaderCellDef> User Type </th>
            <td mat-cell *matCellDef="let user">
              <button class="user-type-button" [matMenuTriggerFor]="userTypeMenu" [disabled]="!canManageRoles">
                @if (user.type) {
                  <span class="user-type">{{ user.type | userTypePipe }}</span>
                } @else {
                  <span class="no-roles">Standard</span>
                }
                @if (canManageRoles) {
                  <mat-icon>arrow_drop_down</mat-icon>
                }
              </button>
              <mat-menu #userTypeMenu="matMenu">
                @for (type of types; track type) {
                  <button mat-menu-item (click)="updateUserType(user, type)">
                    <span>{{ type | userTypePipe}}</span>
                  </button>
                }
              </mat-menu>
            </td>
          </ng-container>

          <!-- Roles Column -->
          <ng-container matColumnDef="roles">
            <th mat-header-cell *matHeaderCellDef> Roles </th>
            <td mat-cell *matCellDef="let user">
              <app-role-chip-row [roles]="user.roles"></app-role-chip-row>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let user">
              @if (user.pending && canManageRoles) {
                <button mat-icon-button color="accent" matTooltip="Approve User" (click)="approveUser(user)">
                  <mat-icon>check_circle_outline</mat-icon>
                </button>
              }
              @if (!user.disabled && canManageRoles) {
                <button mat-icon-button color="warn" matTooltip="Disable User" (click)="disableUser(user)">
                  <mat-icon>block</mat-icon>
                </button>
              }
              @if (user.disabled && canManageRoles) {
                <button mat-icon-button color="warn" matTooltip="Enable User" (click)="enableUser(user)">
                  <mat-icon>how_to_reg</mat-icon>
                </button>
              }
              @if (canManageRoles) {
                <button mat-icon-button color="primary" matTooltip="Manage All Roles" (click)="manageRoles(user)">
                  <mat-icon>manage_accounts</mat-icon>
                </button>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [class.disabled]="row.disabled" 
            [class.pending]="row.pending">
          </tr>
        </table>
      } @else {
        <div class="empty-state">
            <mat-icon>people_outline</mat-icon>
            <h2>No Users Found</h2>
            <p>There are currently no other users in the system.</p>
        </div>
      }
    } @else {
      <div class="loading-state">
          <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      </div>
    }
</div>